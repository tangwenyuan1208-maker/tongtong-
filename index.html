<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>一一团近期接龙到货情况</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { --bg:#f6f7fb; --card:#fff; --muted:#666; --accent:#165DFF; --ok:#19be6b; --danger:#fa5151; }
  body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans SC",sans-serif; background:var(--bg); color:#222; }
  .container { max-width:980px; margin:32px auto; padding:0 16px; }

  /* ✅ Banner inside container */
  .banner { text-align:center; margin-bottom:16px; }
  .banner img { max-width:100%; height:auto; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); object-fit:contain; }

  .card { background:var(--card); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); padding:20px; margin:16px 0; }
  h1 { font-size:24px; margin:0 0 8px; }
  .muted { color:var(--muted); font-size:14px; }
  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  label { font-weight:600; }
  input[type="text"] { padding:10px 12px; border:1px solid #e6e6e6; border-radius:10px; background:#fafafa; min-width:220px; }
  button { background:var(--accent); color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; }
  button.secondary { background:#333; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eee; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { text-align:left; padding:10px; border-bottom:1px solid #f0f0f0; }
  th { background:#fafafa; }
  .error { color:var(--danger); }
  .good { color:var(--ok); }
</style>

</head>
<body>
<div class="container">

  <!-- Banner -->
  <div class="banner">
    <img src="./logo.png" alt="一一团 Logo Banner">
  </div>

  <div class="card">
    <h1>一一团近期接龙到货情况</h1>
    <div class="muted" style="white-space: pre-line;">
💌付款方式💌
付款后，请把付款截图发给团长或者小助手。

💟venmo💟
cherrychen 向日葵🌻头像
bayareaselect 绿植🍃头像

🅿️paypal🅿️
@tlyc 向日葵🌻头像

💴支付宝 微信 💴
人民币实时汇率私信团长付款。
</div>
    <div id="updateTime" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:10px;">
      <label>请输入您的接龙名字：</label>
      <input type="text" id="name" placeholder="输入姓名…" />
      <label class="row" style="gap:6px; font-weight:500;">
        <input type="checkbox" id="case" />
        区分大小写
      </label>
      <button id="searchBtn" disabled>搜索</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><strong>查询结果</strong> <span id="count" class="badge">0</span></div>
      <div class="row">
        <button id="copyBtn" class="secondary" disabled>复制全部</button>
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px;">正在加载表格…</div>
    <div id="list" style="margin-top:8px;"></div>
  </div>

  <!-- 团购到货进度 -->
  <div class="card">
    <h2 style="font-size:18px; margin-bottom:10px;">截至10月26日的团购到货进度：</h2>
    <div style="white-space:pre-line; line-height:1.6;">

1. rototobebe本周会大量到货80%。

2. miki33团鞋子衣服下单后三周左右到货的节奏，在陆续到货。 

3. petit main还没有从日本发出，预计十一月中上旬到货，有部分是还未发售的款式，要十一月中下旬到货。

4. 香水团爱马仕香水到齐，jo malone dipytique预计还要1-2周左右。

5. stample到齐50%，仍在继续到货。

6. 部分之前的skater被卡在海关两个月，团长已重新订货，预计万圣节之后到货。

7. 贝亲指甲刀到齐，其他的下两周到齐。

8. miki袜子到齐，福袋十二月中下旬到货。

9. gelato pique已陆续从日本寄出，预计下两周左右到齐。

10. labubu刚截单，预计十一月中旬左右到齐。
    </div>
  </div>
</div>

<script>
(function(){
  const excelPath = "./orders.xlsx";  // ✅ uses your renamed Excel file
  const LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycbyJxw1wJbYRZMGmy8vjZ41kTEmbpCZzk-e-DvyksbqFNPvhjiw8Mek_lpg8gRkodm7iug/exec"; // <-- paste your Apps Script Web App URL here

  let workbook = null;
  const sheetDataMap = new Map();
  const $ = id => document.getElementById(id);
  const nameInput = $('name');
  const caseBox = $('case');
  const searchBtn = $('searchBtn');
  const copyBtn = $('copyBtn');
  const listDiv = $('list');
  const statusDiv = $('status');
  const countBadge = $('count');
  const updateTime = $('updateTime');

  // Auto-load orders.xlsx
  (async function loadExcel(){
    resetUI();
    try {
      const res = await fetch(excelPath, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const buf = await res.arrayBuffer();
      const data = new Uint8Array(buf);
      workbook = XLSX.read(data, { type: "array" });
      await afterWorkbookLoaded();
    } catch (e) {
      console.error(e);
      setStatus("加载 Excel 文件失败：请确认 orders.xlsx 是否与页面在同一目录下。", true);
    }
  })();

  async function afterWorkbookLoaded(){
    const props = workbook.Props || {};
    const lastModified = props.ModifiedDate || props.LastSaved || props.DateModified || props.CreatedDate;
    if (lastModified) {
      const d = new Date(lastModified);
      updateTime.textContent = "最后更新时间：" + (isNaN(d) ? String(lastModified) : d.toLocaleString("zh-CN", { timeZone:"America/Los_Angeles" }));
    } else {
      updateTime.textContent = "最后更新时间：未知";
    }

    const limit = Math.min(5, workbook.SheetNames.length);
    sheetDataMap.clear();
    for (let i = 0; i < limit; i++) {
      const sName = workbook.SheetNames[i];
      const sheet = workbook.Sheets[sName];
      const aoa = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true, defval:'' });
      sheetDataMap.set(sName, aoa);
    }

    setStatus(`表格加载完成，可以开始查询。`, false);
    searchBtn.disabled = false;
  }

  // Events
  nameInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !searchBtn.disabled) doSearch();
  });
  searchBtn.addEventListener('click', doSearch);
  copyBtn.addEventListener('click', copyResults);

  // Fuzzy matching
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
 function tokenizeCNEN(str){
  // Chinese: individual CJK chars; English: words [A-Za-z]+
  const cn = (str.match(/[\u4e00-\u9fff]/g) || []);
  const en = (str.match(/[A-Za-z]+/g) || []).map(w => w.toLowerCase());
  return { cn, en };
}
function fuzzyMatch(input, target, caseSensitive){
  if (!input || !target) return false;

  // Exact match still wins
  if (caseSensitive) {
    if (target === input) return true;
  } else {
    if (target.toLowerCase() === input.toLowerCase()) return true;
  }

  // Two-Chinese-char OR one-English-word logic
  const { cn, en } = tokenizeCNEN(input);

  // --- Chinese: require >= 2 distinct chars to appear anywhere in target ---
  const uniqueCN = [...new Set(cn)];
  let cnHits = 0;
  for (const ch of uniqueCN) {
    if (ch && target.includes(ch)) {
      cnHits++;
      if (cnHits >= 2) return true;  // ✅ two Chinese characters matched
    }
  }

  // --- English: any one whole word match (case-insensitive unless caseSensitive) ---
  const t = caseSensitive ? target : target.toLowerCase();
  for (const w of en) {
    const word = caseSensitive ? w : w.toLowerCase();
    const re = new RegExp(`\\b${w.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')}\\b`);
    if (re.test(t)) return true;     // ✅ one English word matched
  }

  return false;
}


  // ✅ ADD THIS NEW FUNCTION HERE
  async function logSearch(name, matches) {
    try {
      const payload = {
        name,
        matches,
        page: location.href,
        ua: navigator.userAgent
      };
      await fetch(LOG_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'no-cors',
        body: JSON.stringify(payload)
      });
    } catch (e) {
      console.warn('logSearch failed', e);
    }
  }

  
  // Search
  function doSearch(){
    if (sheetDataMap.size === 0) { setStatus("Excel 文件未加载。", true); return; }
    const key = (nameInput.value || "").trim();
    if (!key) { setStatus("请输入您的接龙名字。", true); return; }
    const caseSensitive = caseBox.checked;
    const results = [];

    for (const [sheet, aoa] of sheetDataMap) {
      for (let r = 0; r < aoa.length; r++) {
        const row = aoa[r]; if (!row) continue;
        const dVal = String((row[3] ?? '')).trim();
        if (!dVal && r === 0) continue;
        if (fuzzyMatch(key, dVal, caseSensitive)) {
          const aRaw = (row[0] ?? '');
          const aDisplay = String(aRaw).trim() === '' ? '暂未到货' : String(aRaw).trim();
          const e = row[4] ?? '';
          const f = formatUSD(row[5]);
          results.push({ sheet, a: aDisplay, d: dVal, e, f });
        }
      }
    }
        logSearch(key, results.length);
    renderResults(results, key);
  }

  function formatUSD(val){
    let num = null;
    if (typeof val === 'number') num = val;
    else {
      const s = String(val ?? '').trim().replace(/,/g, '');
      if (s && !isNaN(s)) num = Number(s);
    }
    if (num === null || !isFinite(num)) return String(val ?? '');
    return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }).format(num);
  }

  function renderResults(rows, key){
    countBadge.textContent = rows.length;
    listDiv.innerHTML = '';
    if (!rows.length) {
      setStatus(`没有找到 "${key}" 的记录。`, true);
      copyBtn.disabled = true;
      return;
    }
    setStatus(`找到 ${rows.length} 条记录。`);

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th>序号</th>
          <th>提货方式</th>
          <th>到货状态</th>
          <th>客户姓名</th>
          <th>接龙内容</th>
          <th>应付金额（USD）</th>
        </tr>
      </thead>`;
    const tb = document.createElement('tbody');
    rows.forEach((r, i) => {
      const tr = document.createElement('tr');
      [i+1, r.sheet, r.a, r.d, r.e, r.f].forEach(txt => {
        const td = document.createElement('td'); td.textContent = txt; tr.appendChild(td);
      });
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    listDiv.appendChild(table);
    copyBtn.disabled = false;
  }

  async function copyResults(){
    const rows = [...document.querySelectorAll('#list tbody tr')]
      .map(tr => [...tr.children].map(td => td.textContent).join('\t'));
    if (!rows.length) return;
    const text = ['序号','提货方式','到货状态','客户姓名','接龙内容','应付金额（USD）'].join('\t') + '\n' + rows.join('\n');
    try {
      await navigator.clipboard.writeText(text);
      setStatus("结果已复制到剪贴板。", false, true);
    } catch {
      setStatus("复制失败，请手动选择复制。", true);
    }
  }

  function setStatus(msg, isError=false, good=false){
    statusDiv.textContent = msg;
    statusDiv.className = isError ? 'error' : good ? 'good' : 'muted';
  }

  function resetUI(){
    workbook = null; sheetDataMap.clear();
    listDiv.innerHTML = ''; countBadge.textContent = '0';
    copyBtn.disabled = true; searchBtn.disabled = true;
    setStatus("正在加载表格…");
  }
})();
</script>
</body>
</html>































