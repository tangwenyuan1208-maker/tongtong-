<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>一一团近期接龙到货情况</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  /* === Kawaii Pink Theme === */
  .multiline { white-space: pre-line; }

  :root {
    --bg:#fff6fb;           /* very light pink */
    --card:#ffffff;
    --muted:#7a6d78;
    --accent:#ff66a1;       /* primary pink */
    --accent-2:#ff8bbb;     /* lighter pink */
    --ok:#3cc88f;           /* mint ok */
    --danger:#ff5d7a;       /* strawberry danger */
    --hl:#ffe5f0;           /* blush highlight */
    --line:#ffd6e6;
    --shadow:0 10px 30px rgba(255,102,161,.12);
  }

  body {
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans SC",sans-serif;
    color:#3a2c36;
    background:
      radial-gradient(1200px 600px at 10% -10%, #fff0f7 10%, transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, #ffeef6 10%, transparent 60%),
      var(--bg);
  }

  .container { max-width:980px; margin:32px auto; padding:0 16px; }

  /* Banner */
  .banner { text-align:center; margin-bottom:16px; }
  .banner img { max-width:100%; height:auto; border-radius:18px; box-shadow:var(--shadow); object-fit:contain; }

  /* Cards */
  .card { background:var(--card); border-radius:20px; box-shadow:var(--shadow); padding:22px; margin:18px 0; border:1px solid var(--line); }
  h1 { font-size:26px; margin:0 0 8px; letter-spacing:.3px; }
  h1::after { content:"  ♡"; color:var(--accent); font-weight:700; }
  .muted { color:var(--muted); font-size:14px; }

  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  label { font-weight:600; }

  /* Inputs */
  input[type="text"] {
    padding:10px 14px; border:1px solid var(--line); border-radius:999px; background:#fff; min-width:240px;
    transition: box-shadow .2s ease, border-color .2s ease;
  }
  input[type="text"]:focus { outline:none; border-color:var(--accent-2); box-shadow:0 0 0 4px rgba(255,136,187,.18); }

  /* Buttons */
  button {
    background:linear-gradient(180deg, var(--accent-2), var(--accent));
    color:#fff; border:none; border-radius:999px; padding:10px 16px; cursor:pointer;
    box-shadow:0 6px 14px rgba(255,102,161,.2);
    transition: transform .08s ease, box-shadow .2s ease, opacity .2s ease;
  }
  button:hover { transform: translateY(-1px); box-shadow:0 10px 18px rgba(255,102,161,.25); }
  button.secondary { background:linear-gradient(180deg,#ffd9e8,#ffb7d5); color:#7a3a55; }
  button:disabled { opacity:.6; cursor:not-allowed; }

  /* Badge */
  .badge { display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; background:#ffe0ef; color:#7a3a55; border:1px solid var(--line); }

  /* Table */
  table { width:100%; border-collapse:collapse; margin-top:10px; table-layout:auto; overflow:hidden; border-radius:14px; border:1px solid var(--line); }
  th, td { text-align:left; padding:12px 12px; border-bottom:1px solid var(--line); vertical-align:top; }
  th { background:linear-gradient(180deg,#fff5fa,#ffeaf3); color:#7a3a55; font-weight:700; }
  .detail-row td { background:#fff9fc; font-size:14px; line-height:1.6; }
  .detail-meta { display:flex; gap:18px; flex-wrap:wrap; }
  .detail-meta b { color:#5c3c4b; }

  /* Highlight */
  mark { background:var(--hl); padding:0 .25em; border-radius:.35em; box-shadow:inset 0 -10px 0 rgba(255,214,230,.45); }

  /* Status */
  .error { color:var(--danger); }
  .good { color:var(--ok); }

  /* Notices */
  .empty-box {
    background:linear-gradient(135deg, rgba(255,240,247,.8) 0 10px, rgba(255,255,255,.8) 10px 20px) repeat;
    background-size:20px 20px;
    border:1px dashed #ffc1d7; border-radius:16px; padding:16px; color:#5c3c4b;
  }
  .empty-box::before { content:"🛍️✨ "; margin-right:6px; }

  /* Mobile */
  @media (max-width: 600px) {
    body { font-size:15px; }
    th, td { padding:10px; }
    .detail-row td { font-size:13px; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Banner -->
  <div class="banner">
    <img src="./logo.png" alt="一一团 Logo Banner">
  </div>

  <div class="card">
    <h1>一一团近期接龙到货情况</h1>
    <div class="muted multiline">
💌付款方式💌
付款后，请把付款截图发给团长或者小助手。

💟venmo💟
cherrychen 向日葵🌻头像
bayareaselect 绿植🍃头像

🅿️paypal🅿️
@tlyc 向日葵🌻头像

💴支付宝 微信 💴
人民币实时汇率私信团长付款。
    </div>
    <div id="updateTime" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:10px;">
      <label>请输入您的接龙名字：</label>
      <input type="text" id="name" placeholder="输入姓名…" />
      <label class="row" style="gap:6px; font-weight:500;">
        <input type="checkbox" id="showPayStatus" />
        是否查看支付状态
      </label>
      <button id="searchBtn" disabled>搜索</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><strong>查询结果</strong> <span id="count" class="badge">0</span></div>
      <div class="row">
        <button id="copyBtn" class="secondary" disabled>复制全部</button>
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px;">正在加载表格…</div>

    <!-- The note (if any) will be inserted right before this list -->
    <div id="list" style="margin-top:8px;"></div>
  </div>

  <!-- 到货进度说明 -->
  <div class="card">
    <h2 style="font-size:18px; margin-bottom:10px;">截至10月28日的团购到货进度：</h2>
    <div style="white-space:pre-line; line-height:1.6;">
 1. rototobebe还有25%没到。
 2. miki预定团的鞋子衣服下单后三周左右到货的节奏，在陆续到货。
 3. petit main还没有从日本发出，预计十一月中上旬到货，有部分是还未发售的款式，要十一月中下旬到货。
 4. 香水团爱马仕香水到齐，jo malone dipytique byredo预计还要1-2周左右。
 5. stample到齐60%，仍在继续到货。
 6. 部分之前的skater被卡在海关两个月，团长已重新订货，十一月初到齐。
 7. 贝亲指甲刀到齐，其他的下两周到齐。
 8. miki袜子到齐，福袋十二月中下旬到货。
 9. gelato pique已陆续从日本寄出，预计下两周左右到齐。
10. labubu供应商已发货，预计下两周内陆续到货。
    </div>
  </div>
</div>

<script>
(function(){
  const excelPath = "./orders.xlsx";  // Excel file

  let workbook = null;
  const sheetDataMap = new Map();
  const $ = id => document.getElementById(id);
  const nameInput = $('name');
  const showPayStatusBox = $('showPayStatus');
  const searchBtn = $('searchBtn');
  const copyBtn = $('copyBtn');
  const listDiv = $('list');
  const statusDiv = $('status');
  const countBadge = $('count');
  const updateTime = $('updateTime');

  // JS error -> status
  window.addEventListener('error', (ev) => {
    try {
      const msg = (ev && ev.message) ? ev.message : String(ev);
      statusDiv.textContent = '脚本错误：' + msg;
      statusDiv.className = 'error';
    } catch {}
  });

  // Helpers
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function isSingleChineseChar(str){ return /^[\u4e00-\u9fff]$/.test(str); }

  // Extract tokens (CN 2+ substrings, EN words, alnum handles like egg57)
  function extractTokensCNEN(input){
    const cnSeq = (input.match(/[\u4e00-\u9fff]+/g) || []);
    const cnSubstrings = [];
    for (const seq of cnSeq) {
      if (seq.length >= 2) {
        for (let L = 2; L <= seq.length; L++) {
          for (let i = 0; i + L <= seq.length; i++) {
            cnSubstrings.push(seq.slice(i, i+L));
          }
        }
      }
    }
    const enWords = (input.match(/[A-Za-z]+/g) || []).map(w => w.toLowerCase());
    const enAlnum = (input.match(/(?:[A-Za-z]+[0-9]+|[0-9]+[A-Za-z]+)[A-Za-z0-9]*/g) || []).map(s => s.toLowerCase());
    return { cnSubstrings, enWords, enAlnum };
  }

  // Matching rule
  function matchByRule(userInput, targetText){
    if (!userInput || !targetText) return false;
    const t = String(targetText);
    const tl = t.toLowerCase();

    // Quick: alphanumeric handle (egg57)
    const rawHandle = (userInput || "").trim();
    if (/[A-Za-z]\d|\d[A-Za-z]/.test(rawHandle)) {
      if (tl.indexOf(rawHandle.toLowerCase()) !== -1) return true;
    }

    // Single Chinese char
    if (isSingleChineseChar(t.trim()) && userInput.includes(t.trim())) return true;

    const { cnSubstrings, enWords, enAlnum } = extractTokensCNEN(userInput);

    // CN 2+ substring
    for (const sub of cnSubstrings) { if (sub && t.includes(sub)) return true; }

    // EN whole word (case-insensitive)
    for (const w of enWords) {
      if (!w) continue;
      const re = new RegExp(`\\b${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
      if (re.test(tl)) return true;
    }

    // Alnum handle substring
    for (const h of enAlnum) { if (!h) continue; if (tl.indexOf(h) !== -1) return true; }

    // Special-char raw fallback
    if (cnSubstrings.length === 0 && enWords.length === 0 && enAlnum.length === 0) {
      const raw = userInput.trim();
      if (raw && t.includes(raw)) return true;
    }
    return false;
  }

  // Highlight
  function highlightMatches(userInput, targetText){
    const text = String(targetText || '');
    if (!userInput || !text) return escapeHTML(text);

    const raw = (userInput || "").trim();
    const ranges = [];

    // alnum quick
    if (/[A-Za-z]\d|\d[A-Za-z]/.test(raw)) {
      const low = text.toLowerCase(), needle = raw.toLowerCase();
      let start = 0, idx;
      while ((idx = low.indexOf(needle, start)) !== -1) {
        ranges.push([idx, idx + needle.length]); start = idx + Math.max(1, needle.length);
      }
    }

    // single CN char
    if (isSingleChineseChar(text.trim()) && raw.includes(text.trim())) return '<mark>' + escapeHTML(text) + '</mark>';

    const { cnSubstrings, enWords, enAlnum } = extractTokensCNEN(raw);

    // CN 2+ substrings
    for (const sub of cnSubstrings) {
      if (!sub) continue; let i = text.indexOf(sub);
      while (i !== -1) { ranges.push([i, i + sub.length]); i = text.indexOf(sub, i + 1); }
    }

    // EN words
    for (const w of enWords) {
      if (!w) continue; const re = new RegExp(`\\b${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi'); let m;
      while ((m = re.exec(text)) !== null) { ranges.push([m.index, m.index + m[0].length]); }
    }

    // Alnum handles
    for (const h of enAlnum) {
      if (!h) continue; const low = text.toLowerCase(); let i=0, idx;
      while ((idx = low.indexOf(h, i)) !== -1) { ranges.push([idx, idx + h.length]); i = idx + Math.max(1, h.length); }
    }

    // Raw fallback
    if (!cnSubstrings.length && !enWords.length && !enAlnum.length && raw) {
      let i = 0, idx; while ((idx = text.indexOf(raw, i)) !== -1) { ranges.push([idx, idx + raw.length]); i = idx + Math.max(1, raw.length); }
    }

    if (!ranges.length) return escapeHTML(text);

    // merge
    ranges.sort((a,b)=>a[0]-b[0]||a[1]-b[1]);
    const merged=[]; let cur=ranges[0];
    for (let k=1;k<ranges.length;k++){ const r=ranges[k]; if (r[0]<=cur[1]) cur[1]=Math.max(cur[1],r[1]); else { merged.push(cur); cur=r; } }
    merged.push(cur);

    // render
    let out='', last=0;
    for (const [s,e] of merged){ out+=escapeHTML(text.slice(last,s)); out+='<mark>'+escapeHTML(text.slice(s,e))+'</mark>'; last=e; }
    out+=escapeHTML(text.slice(last));
    return out;
  }

  // Insert a pre-result notice BEFORE the results list
  function insertPreResultNotice(html){
    // remove old
    const old = document.getElementById('preNote');
    if (old) old.remove();
    // insert new before listDiv
    const note = document.createElement('div');
    note.id = 'preNote';
    note.className = 'empty-box multiline';
    note.style.marginBottom = '10px';
    note.innerHTML = html;
    listDiv.parentNode.insertBefore(note, listDiv);
  }

  // Auto-load Excel
  (async function loadExcel(){
    resetUI();
    try {
      const res = await fetch(excelPath, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = new Uint8Array(await res.arrayBuffer());
      workbook = XLSX.read(data, { type: "array" });
      await afterWorkbookLoaded();
    } catch (e) {
      console.error(e);
      setStatus("加载 Excel 文件失败：请确认 orders.xlsx 是否与页面在同一目录下。", true);
    }
  })();

  async function afterWorkbookLoaded(){
    const props = workbook.Props || {};
    const lastModified = props.ModifiedDate || props.LastSaved || props.DateModified || props.CreatedDate;
    updateTime.textContent = "最后更新时间：" + (lastModified
      ? (isNaN(new Date(lastModified)) ? String(lastModified) : new Date(lastModified).toLocaleString("zh-CN", { timeZone:"America/Los_Angeles" }))
      : "未知");

    const limit = Math.min(5, workbook.SheetNames.length);
    sheetDataMap.clear();
    for (let i = 0; i < limit; i++) {
      const sName = workbook.SheetNames[i];
      const sheet = workbook.Sheets[sName];
      const aoa = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true, defval:'' });
      sheetDataMap.set(sName, aoa);
    }

    setStatus(`表格加载完成，可以开始查询。`);
    searchBtn.disabled = false;
  }

  // Events
  nameInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !searchBtn.disabled) doSearch(); });
  nameInput.addEventListener('input', () => { searchBtn.disabled = !(nameInput.value || '').trim(); });
  searchBtn.addEventListener('click', doSearch);
  showPayStatusBox.addEventListener('change', () => { if (!searchBtn.disabled) doSearch(); });
  copyBtn.addEventListener('click', copyResults);

  // Search
  function doSearch(){
    if (sheetDataMap.size === 0) { setStatus("Excel 文件未加载。", true); return; }
    const key = (nameInput.value || "").trim();
    if (!key) { setStatus("请输入您的接龙名字。", true); return; }

    const results = [];
    // 列映射：A=0(到货状态), B=1(支付状态), D=3(客户姓名), E=4(接龙内容), F=5(金额)
    for (const [_, aoa] of sheetDataMap) {
      for (let r = 0; r < aoa.length; r++) {
        const row = aoa[r]; if (!row) continue;
        const dVal = String((row[3] ?? '')).trim();
        if (!dVal && r === 0) continue; // 表头
        if (matchByRule(key, dVal)) {
          const aRaw = (row[0] ?? '');
          const aDisplay = String(aRaw).trim() === '' ? '暂未到货' : String(aRaw).trim();
          const bRaw = (row[1] ?? '');
          const bDisplay = String(bRaw).trim() === '' ? '未支付' : String(bRaw).trim();
          const e = row[4] ?? '';
          const f = formatUSD(row[5]);
          results.push({ a:aDisplay, b:bDisplay, d:dVal, dHTML:highlightMatches(key, dVal), e, f });
        }
      }
    }

    renderResults(results, key);
  }

  function formatUSD(val){
    let num = null;
    if (typeof val === 'number') num = val;
    else {
      const s = String(val ?? '').trim().replace(/,/g, '');
      if (s && !isNaN(s)) num = Number(s);
    }
    if (num === null || !isFinite(num)) return String(val ?? '');
    return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }).format(num);
  }

  // Render
  function renderResults(rows, key){
    countBadge.textContent = rows.length;
    listDiv.innerHTML = '';
    const showPayStatus = showPayStatusBox.checked;

    // Always clear previous pre-note
    const existed = document.getElementById('preNote');
    if (existed) existed.remove();

    if (!rows.length) {
      setStatus(`没有找到 "${key}" 的记录。`, true);
      insertPreResultNotice(
`哈哈这位客官，您可能是<b>“买了个寂寞”</b>😂
库存小二刚翻遍小本本，发现您最近没有下单哦～

不急不急～客栈里好物多多，您可以先去现货区或其他接龙摊位逛逛，
说不定下一眼缘分的宝贝就在等您呢✨

客官请随意，喜欢哪个尽管拍，小二随时为您打包～📦💨`
      );
      copyBtn.disabled = true;
      return;
    }

    // ≥2 results → show the thank-you note BEFORE results (regardless of same name)
    if (rows.length >= 2) {
      insertPreResultNotice(
`亲爱的客官们，最近看到您囤货的热情，小二感动得眼泪都快掉进打包袋里了😭
感谢您一路支持、信任与厚爱！
您的每一次下单，都是对小二继续努力的最大鼓励❤️
祝您日日有好物，件件都喜欢！`
      );
    }

    setStatus(`找到 ${rows.length} 条记录。`);

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th style="width:64px;">序号</th>
          <th style="width:120px;">到货状态</th>
          ${showPayStatus ? '<th style="width:120px;">支付状态</th>' : ''}
          <th>客户姓名</th>
        </tr>
      </thead>`;
    const tb = document.createElement('tbody');

    rows.forEach((r, i) => {
      // main row
      const tr = document.createElement('tr');
      const cell = (txt) => { const td = document.createElement('td'); td.textContent = txt; tr.appendChild(td); };
      const cellHTML = (html) => { const td = document.createElement('td'); td.innerHTML = html; tr.appendChild(td); };

      cell(i+1);
      cell(r.a);
      if (showPayStatus) cell(r.b === '' ? '未支付' : r.b);
      cellHTML(r.dHTML);
      tb.appendChild(tr);

      // detail row（E, F）
      const tr2 = document.createElement('tr');
      tr2.className = 'detail-row';
      const td = document.createElement('td');
      td.colSpan = showPayStatus ? 4 : 3;

      const wrap = document.createElement('div');
      wrap.className = 'detail-meta';
      const eDiv = document.createElement('div');
      const fDiv = document.createElement('div');
      eDiv.innerHTML = `<b>接龙内容：</b>${escapeHTML(String(r.e ?? ''))}`;
      fDiv.innerHTML = `<b>应付金额（USD）：</b>${escapeHTML(String(r.f ?? ''))}`;
      wrap.appendChild(eDiv);
      wrap.appendChild(fDiv);

      td.appendChild(wrap);
      tr2.appendChild(td);
      tb.appendChild(tr2);
    });

    table.appendChild(tb);
    listDiv.appendChild(table);
    copyBtn.disabled = false;
  }

  // Copy TSV（包含 E、F 列）
  async function copyResults(){
    const showPayStatus = showPayStatusBox.checked;
    const header = ['序号','到货状态'];
    if (showPayStatus) header.push('支付状态');
    header.push('客户姓名','接龙内容','应付金额（USD）');

    const key = (nameInput.value || "").trim();
    const res = [];
    for (const [_, aoa] of sheetDataMap) {
      for (let r = 0; r < aoa.length; r++) {
        const row = aoa[r]; if (!row) continue;
        const dVal = String((row[3] ?? '')).trim();
        if (!dVal && r === 0) continue;
        if (matchByRule(key, dVal)) {
          const aRaw = (row[0] ?? '');
          const aDisplay = String(aRaw).trim() === '' ? '暂未到货' : String(aRaw).trim();
          const bRaw = (row[1] ?? '');
          const bDisplay = String(bRaw).trim() === '' ? '未支付' : String(bRaw).trim();
          const e = row[4] ?? '';
          const f = formatUSD(row[5]);
          res.push({ a:aDisplay, b:bDisplay, d:dVal, e, f });
        }
      }
    }
    const lines = res.map((r, i) => {
      const arr = [i+1, r.a];
      if (showPayStatus) arr.push(r.b);
      arr.push(r.d, r.e, r.f);
      return arr.join('\t');
    });

    const text = header.join('\t') + '\n' + lines.join('\n');
    try {
      await navigator.clipboard.writeText(text);
      setStatus("结果已复制到剪贴板。", false, true);
    } catch {
      setStatus("复制失败，请手动选择复制。", true);
    }
  }

  function setStatus(msg, isError=false, good=false){
    statusDiv.textContent = msg;
    statusDiv.className = isError ? 'error' : good ? 'good' : 'muted';
  }

  function resetUI(){
    workbook = null; sheetDataMap.clear();
    listDiv.innerHTML = ''; countBadge.textContent = '0';
    copyBtn.disabled = true; searchBtn.disabled = true;
    setStatus("正在加载表格…");
  }
})();
</script>
</body>
</html>































































