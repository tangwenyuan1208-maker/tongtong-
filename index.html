<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¸€ä¸€å›¢è¿‘æœŸæ¥é¾™åˆ°è´§æƒ…å†µ Â· ä¸‡åœ£èŠ‚ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  /* === Halloween Theme (Pumpkin Orange, Midnight Black, Candy Purple) === */
  .multiline { white-space: pre-line; }

  :root{
    --bg: #0d0d0f;            /* night sky */
    --bg-glow1: #191922;
    --bg-glow2: #13111a;
    --card: #121216;          /* dark card */
    --muted: #b9b7c3;         /* soft gray */
    --accent: #ff7a00;        /* pumpkin orange */
    --accent-2:#ffa04d;       /* lighter orange */
    --accent-3:#b56cff;       /* candy purple for accents */
    --ok:#3ddc97;             /* mint green */
    --danger:#ff4d6d;         /* spooky pink-red */
    --hl:#2a1b00;             /* dark amber for highlight base */
    --hl-glow:#ffad42;        /* glow color for highlight text */
    --line:#2a2533;           /* subtle border */
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans SC",sans-serif;
    color:#f2efe9;
    background:
      radial-gradient(1200px 600px at -10% -20%, #1c1626 5%, transparent 60%),
      radial-gradient(1200px 600px at 120% -10%, #1a1424 5%, transparent 60%),
      linear-gradient(180deg, var(--bg-glow1), var(--bg-glow2) 45%, var(--bg));
    overflow-x: hidden; /* é¿å…å¹½çµè¶…å‡ºé€ æˆæ¨ªå‘æ»šåŠ¨ */
  }

  .container{ max-width:980px; margin:28px auto 40px; padding:0 16px; position:relative; z-index: 2; }

  /* --- Halloween Top Banner --- */
  .top-hero{
    position:relative;
    margin:0 0 16px 0;
    padding:20px 16px 24px;
    text-align:center;
    color:#ffe7c2;
    border-radius:18px;
    border:1px solid #3a2a1a;
    box-shadow: var(--shadow);
    background:
      radial-gradient(600px 200px at 10% 0%, #2b1f14 0, transparent 70%),
      radial-gradient(600px 200px at 90% 0%, #2b1f14 0, transparent 70%),
      linear-gradient(180deg, #2a1b12, #1a1210 70%, #120e0b);
    overflow:hidden;
  }
  .top-hero::before, .top-hero::after{
    content:"ğŸ¦‡";
    position:absolute;
    font-size:28px; opacity:.35;
  }
  .top-hero::before{ left:12px; top:10px; transform:rotate(-14deg) }
  .top-hero::after{ right:12px; top:14px; transform:rotate(8deg) }
  .top-hero h2{
    margin:4px 0 4px;
    font-size:22px; font-weight:800; letter-spacing:.5px;
    color:#ffd28a;
    text-shadow:0 0 10px rgba(255,122,0,.25), 0 0 18px rgba(255,122,0,.15);
    animation: pumpkinGlow 2.4s ease-in-out infinite;
  }
  .top-hero .sub{
    font-size:13.5px; color:#ffbd66;
  }

  /* Cards */
  .card{
    background:var(--card);
    border-radius:18px;
    box-shadow: var(--shadow);
    padding:20px;
    margin:16px 0;
    border:1px solid var(--line);
    position: relative;
  }
  h1{ font-size:24px; margin:0 0 8px; letter-spacing:.3px; color:#ffd7a1; }
  h1::after{ content:"  ğŸƒ"; color:var(--accent-2); font-weight:700; }
  .muted{ color:var(--muted); font-size:14px; }

  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  label{ font-weight:600; color:#ffe2bd; }

  /* Inputs */
  input[type="text"]{
    padding:10px 14px;
    border:1px solid #3a2f46;
    border-radius:999px;
    background:#1a1720;
    color:#f9f5ee;
    min-width:240px;
    transition: box-shadow .2s ease, border-color .2s ease, background .2s;
  }
  input[type="text"]::placeholder{ color:#8f8699; }
  input[type="text"]:focus{
    outline:none; border-color:#4d2f12;
    box-shadow:0 0 0 4px rgba(255,122,0,.18), 0 0 18px rgba(255,122,0,.15);
    background:#1f1a28;
  }

  /* Buttons */
  button{
    background:linear-gradient(180deg, var(--accent-2), var(--accent));
    color:#1a0f07; font-weight:800;
    border:none; border-radius:999px;
    padding:10px 16px; cursor:pointer;
    box-shadow:0 8px 16px rgba(255,122,0,.25);
    transition: transform .08s ease, box-shadow .2s ease, opacity .2s ease;
  }
  button:hover{ transform:translateY(-1px); box-shadow:0 12px 20px rgba(255,122,0,.32); }
  button.secondary{
    background:linear-gradient(180deg,#3c304c,#2c2439);
    color:#e8dbff;
  }
  button:disabled{ opacity:.6; cursor:not-allowed; }

  /* Badge */
  .badge{
    display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px;
    background:#2c2130; color:#ffc680; border:1px solid #4a394e;
  }

  /* Table */
  table{
    width:100%; border-collapse:collapse; margin-top:10px; table-layout:auto;
    overflow:hidden; border-radius:14px; border:1px solid var(--line);
  }
  th, td{
    text-align:left; padding:12px 12px; border-bottom:1px solid #292231; vertical-align:top;
  }
  th{
    background:linear-gradient(180deg, #241b2a, #1b1520);
    color:#ffcf83; font-weight:800;
    text-shadow:0 0 10px rgba(255,122,0,.12);
  }
  .detail-row td{
    background:#16121a; font-size:14px; line-height:1.6;
  }
  .detail-meta{ display:flex; gap:18px; flex-wrap:wrap; }
  .detail-meta b{ color:#ffdba3; }

  /* Highlight (ember glow) */
  mark{
    background: var(--hl);
    color: var(--hl-glow);
    padding:0 .25em; border-radius:.35em;
    box-shadow: inset 0 -10px 0 rgba(255,140,0,.15), 0 0 0 1px rgba(255,121,0,.15);
  }

  /* Notices (webbed box) */
  .empty-box{
    background:
      radial-gradient(140px 40px at 15% 10%, rgba(255,122,0,.12), transparent 70%),
      radial-gradient(140px 40px at 85% 0%, rgba(181,108,255,.12), transparent 70%),
      repeating-linear-gradient(135deg, rgba(255,122,0,.07), rgba(255,122,0,.07) 6px, rgba(0,0,0,0) 6px, rgba(0,0,0,0) 12px),
      #151018;
    border:1px dashed #6a4a20; border-radius:16px; padding:16px; color:#ffe9c9;
  }
  .empty-box::before{ content:"ğŸ•¸ï¸ğŸ•·ï¸ "; margin-right:6px; }

  /* --- Pumpkin ambient glow (æš—å¤œå—ç“œå…‰æ•ˆ) --- */
  .pumpkin-glow{
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
  }
  .pumpkin-glow::before,
  .pumpkin-glow::after{
    content:"";
    position:absolute;
    border-radius:50%;
    filter: blur(60px);
    opacity:.25;
    animation: emberPulse 4.5s ease-in-out infinite;
  }
  .pumpkin-glow::before{
    width: 42vmax; height: 42vmax;
    left: -10vmax; bottom: -12vmax;
    background: radial-gradient(circle at 50% 50%, rgba(255,122,0,.28), rgba(255,122,0,.05) 60%, transparent 70%);
  }
  .pumpkin-glow::after{
    width: 32vmax; height: 32vmax;
    right: -8vmax; top: -10vmax;
    background: radial-gradient(circle at 50% 50%, rgba(181,108,255,.24), rgba(181,108,255,.05) 60%, transparent 70%);
    animation-delay: 1.2s;
  }

  /* --- Floating Ghosts Container --- */
  .ghost-layer{
    pointer-events: none;
    position: fixed;
    inset: 0;
    overflow: hidden;
    z-index: 3; /* é«˜äºèƒŒæ™¯å…‰æ•ˆï¼Œä½äºå†…å®¹ */
  }
  .ghost{
    position: absolute;
    font-size: 28px;
    opacity: .10; /* è‹¥æƒ³æ›´æ˜æ˜¾å¯è°ƒåˆ° .25 */
    filter: drop-shadow(0 4px 6px rgba(0,0,0,.25));
    animation: floatGhost linear infinite;
    user-select: none;
  }

  /* Keyframes */
  @keyframes pumpkinGlow{
    0%,100%{ text-shadow:0 0 10px rgba(255,122,0,.25), 0 0 18px rgba(255,122,0,.15); transform: translateY(0); }
    50%{ text-shadow:0 0 16px rgba(255,160,77,.35), 0 0 24px rgba(255,122,0,.25); transform: translateY(-1px); }
  }
  @keyframes emberPulse{
    0%,100%{ transform: scale(1); opacity:.22; }
    50%{ transform: scale(1.07); opacity:.33; }
  }
  @keyframes floatGhost{
    0%{ transform: translate3d(var(--xStart, -10vw), var(--y, 0vh), 0) rotate(0deg); }
    100%{ transform: translate3d(110vw, calc(var(--y, 0vh) + var(--drift, 12vh)), 0) rotate(6deg); }
  }

  /* Mobile */
  @media (max-width: 600px){
    body{ font-size:15px; }
    th, td{ padding:10px; }
    .detail-row td{ font-size:13px; }
    .ghost{ font-size: 22px; }
  }
</style>
</head>
<body>

<!-- èƒŒæ™¯ï¼šæš—å¤œå—ç“œå…‰æ•ˆ -->
<div class="pumpkin-glow" aria-hidden="true"></div>

<!-- å‰æ™¯ï¼šå°å¹½çµæ¼‚æµ®å±‚ -->
<div class="ghost-layer" id="ghostLayer" aria-hidden="true"></div>

<div class="container">

  <!-- Halloween banner -->
  <div class="top-hero" role="banner" aria-label="ä¸‡åœ£èŠ‚å¿«ä¹">
    <h2>ğŸƒ ä¸‡åœ£èŠ‚å¿«ä¹ï¼ä¸€ä¸€å›¢è´­ç¥å¤§å®¶ç³–æœå¤šå¤šã€å¼€å¿ƒæ£è›‹ï¼</h2>
    <div class="sub">Trick or Treat Â· ç”œç”œä¸æ€•è›€ç‰™ï¼ˆè®°å¾—åˆ·ç‰™å‘€ğŸª¥ï¼‰Â· å¥½è¿è¿è¿ ğŸ‘»</div>
  </div>

  <div class="card">
    <h1>ä¸€ä¸€å›¢è¿‘æœŸæ¥é¾™åˆ°è´§æƒ…å†µ</h1>
    <div class="muted multiline">
ğŸ’Œä»˜æ¬¾æ–¹å¼ğŸ’Œ
ä»˜æ¬¾åï¼Œè¯·æŠŠä»˜æ¬¾æˆªå›¾å‘ç»™å›¢é•¿æˆ–è€…å°åŠ©æ‰‹ã€‚

ğŸ’ŸvenmoğŸ’Ÿ
cherrychen å‘æ—¥è‘µğŸŒ»å¤´åƒ
bayareaselect ç»¿æ¤ğŸƒå¤´åƒ

ğŸ…¿ï¸paypalğŸ…¿ï¸
@tlyc å‘æ—¥è‘µğŸŒ»å¤´åƒ

ğŸ’´æ”¯ä»˜å® å¾®ä¿¡ ğŸ’´
äººæ°‘å¸å®æ—¶æ±‡ç‡ç§ä¿¡å›¢é•¿ä»˜æ¬¾ã€‚
    </div>
    <div id="updateTime" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:10px;">
      <label>è¯·è¾“å…¥æ‚¨çš„æ¥é¾™åå­—ï¼š</label>
      <input type="text" id="name" placeholder="è¾“å…¥å§“åâ€¦" />
      <label class="row" style="gap:6px; font-weight:500;">
        <input type="checkbox" id="showPayStatus" />
        æ˜¯å¦æŸ¥çœ‹æ”¯ä»˜çŠ¶æ€
      </label>
      <button id="searchBtn" disabled>æœç´¢</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><strong>æŸ¥è¯¢ç»“æœ</strong> <span id="count" class="badge">0</span></div>
      <div class="row">
        <button id="copyBtn" class="secondary" disabled>å¤åˆ¶å…¨éƒ¨</button>
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px;">æ­£åœ¨åŠ è½½è¡¨æ ¼â€¦</div>
    <!-- The pre-note (if any) is inserted just before list -->
    <div id="list" style="margin-top:8px;"></div>
  </div>

  <!-- åˆ°è´§è¿›åº¦è¯´æ˜ -->
  <div class="card">
    <h2 style="font-size:18px; margin-bottom:10px;">æˆªè‡³10æœˆ28æ—¥çš„å›¢è´­åˆ°è´§è¿›åº¦ï¼š</h2>
    <div style="white-space:pre-line; line-height:1.6;">
 1. rototobebeè¿˜æœ‰25%æ²¡åˆ°ã€‚
 2. mikié¢„å®šå›¢çš„é‹å­è¡£æœä¸‹å•åä¸‰å‘¨å·¦å³åˆ°è´§çš„èŠ‚å¥ï¼Œåœ¨é™†ç»­åˆ°è´§ã€‚
 3. petit mainè¿˜æ²¡æœ‰ä»æ—¥æœ¬å‘å‡ºï¼Œé¢„è®¡åä¸€æœˆä¸­ä¸Šæ—¬åˆ°è´§ï¼Œæœ‰éƒ¨åˆ†æ˜¯è¿˜æœªå‘å”®çš„æ¬¾å¼ï¼Œè¦åä¸€æœˆä¸­ä¸‹æ—¬åˆ°è´§ã€‚
 4. é¦™æ°´å›¢çˆ±é©¬ä»•é¦™æ°´åˆ°é½ï¼Œjo malone dipytique byredoé¢„è®¡è¿˜è¦1-2å‘¨å·¦å³ã€‚
 5. stampleåˆ°é½60%ï¼Œä»åœ¨ç»§ç»­åˆ°è´§ã€‚
 6. éƒ¨åˆ†ä¹‹å‰çš„skaterè¢«å¡åœ¨æµ·å…³ä¸¤ä¸ªæœˆï¼Œå›¢é•¿å·²é‡æ–°è®¢è´§ï¼Œåä¸€æœˆåˆåˆ°é½ã€‚
 7. è´äº²æŒ‡ç”²åˆ€åˆ°é½ï¼Œå…¶ä»–çš„ä¸‹ä¸¤å‘¨åˆ°é½ã€‚
 8. mikiè¢œå­åˆ°é½ï¼Œç¦è¢‹åäºŒæœˆä¸­ä¸‹æ—¬åˆ°è´§ã€‚
 9. gelato piqueå·²é™†ç»­ä»æ—¥æœ¬å¯„å‡ºï¼Œé¢„è®¡ä¸‹ä¸¤å‘¨å·¦å³åˆ°é½ã€‚
10. labubuä¾›åº”å•†å·²å‘è´§ï¼Œé¢„è®¡ä¸‹ä¸¤å‘¨å†…é™†ç»­åˆ°è´§ã€‚
    </div>
  </div>
</div>

<script>
(function(){
  const excelPath = "./orders.xlsx";
  const LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycbyJxw1wJbYRZMGmy8vjZ41kTEmbpCZzk-e-DvyksbqFNPvhjiw8Mek_lpg8gRkodm7iug/exec";

  let workbook = null;
  const sheetDataMap = new Map();
  const $ = id => document.getElementById(id);
  const nameInput = $('name');
  const showPayStatusBox = $('showPayStatus');
  const searchBtn = $('searchBtn');
  const copyBtn = $('copyBtn');
  const listDiv = $('list');
  const statusDiv = $('status');
  const countBadge = $('count');
  const updateTime = $('updateTime');

  // show JS errors in status (helpful on mobile)
  window.addEventListener('error', (ev) => {
    try {
      const msg = (ev && ev.message) ? ev.message : String(ev);
      statusDiv.textContent = 'è„šæœ¬é”™è¯¯ï¼š' + msg;
      statusDiv.className = 'error';
    } catch {}
  });

  /* ---------- Helpers ---------- */
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function isSingleChineseChar(str){ return /^[\u4e00-\u9fff]$/.test(str); }

  // Extract tokens (CN 2+ substrings, EN words, alnum handles like egg57)
  function extractTokensCNEN(input){
    const cnSeq = (input.match(/[\u4e00-\u9fff]+/g) || []);
    const cnSubstrings = [];
    for (const seq of cnSeq) {
      if (seq.length >= 2) {
        for (let L = 2; L <= seq.length; L++) {
          for (let i = 0; i + L <= seq.length; i++) {
            cnSubstrings.push(seq.slice(i, i+L));
          }
        }
      }
    }
    const enWords = (input.match(/[A-Za-z]+/g) || []).map(w => w.toLowerCase());
    const enAlnum = (input.match(/(?:[A-Za-z]+[0-9]+|[0-9]+[A-Za-z]+)[A-Za-z0-9]*/g) || []).map(s => s.toLowerCase());
    return { cnSubstrings, enWords, enAlnum };
  }

  // Matching rule
  function matchByRule(userInput, targetText){
    if (!userInput || !targetText) return false;
    const t = String(targetText);
    const tl = t.toLowerCase();

    // Quick: alphanumeric handle (egg57)
    const rawHandle = (userInput || "").trim();
    if (/[A-Za-z]\d|\d[A-Za-z]/.test(rawHandle)) {
      if (tl.indexOf(rawHandle.toLowerCase()) !== -1) return true;
    }

    // Single Chinese char
    if (isSingleChineseChar(t.trim()) && userInput.includes(t.trim())) return true;

    const { cnSubstrings, enWords, enAlnum } = extractTokensCNEN(userInput);

    // CN 2+ substring
    for (const sub of cnSubstrings) { if (sub && t.includes(sub)) return true; }

    // EN whole word (case-insensitive)
    for (const w of enWords) {
      if (!w) continue;
      const re = new RegExp(`\\b${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
      if (re.test(tl)) return true;
    }

    // Alnum handle substring
    for (const h of enAlnum) { if (!h) continue; if (tl.indexOf(h) !== -1) return true; }

    // Special-char raw fallback
    if (cnSubstrings.length === 0 && enWords.length === 0 && enAlnum.length === 0) {
      const raw = userInput.trim();
      if (raw && t.includes(raw)) return true;
    }
    return false;
  }

  // Highlight
  function highlightMatches(userInput, targetText){
    const text = String(targetText || '');
    if (!userInput || !text) return escapeHTML(text);

    const raw = (userInput || "").trim();
    const ranges = [];

    // alnum quick
    if (/[A-Za-z]\d|\d[A-Za-z]/.test(raw)) {
      const low = text.toLowerCase(), needle = raw.toLowerCase();
      let start = 0, idx;
      while ((idx = low.indexOf(needle, start)) !== -1) {
        ranges.push([idx, idx + needle.length]); start = idx + Math.max(1, needle.length);
      }
    }

    // single CN char
    if (isSingleChineseChar(text.trim()) && raw.includes(text.trim())) return '<mark>' + escapeHTML(text) + '</mark>';

    const { cnSubstrings, enWords, enAlnum } = extractTokensCNEN(raw);

    // CN 2+ substrings
    for (const sub of cnSubstrings) {
      if (!sub) continue; let i = text.indexOf(sub);
      while (i !== -1) { ranges.push([i, i + sub.length]); i = text.indexOf(sub, i + 1); }
    }

    // EN words
    for (const w of enWords) {
      if (!w) continue; const re = new RegExp(`\\b${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi'); let m;
      while ((m = re.exec(text)) !== null) { ranges.push([m.index, m.index + m[0].length]); }
    }

    // Alnum handles
    for (const h of enAlnum) {
      if (!h) continue; const low = text.toLowerCase(); let i=0, idx;
      while ((idx = low.indexOf(h, i)) !== -1) { ranges.push([idx, idx + h.length]); i = idx + Math.max(1, h.length); }
    }

    // Raw fallback
    if (!cnSubstrings.length && !enWords.length && !enAlnum.length && raw) {
      let i = 0, idx; while ((idx = text.indexOf(raw, i)) !== -1) { ranges.push([idx, idx + raw.length]); i = idx + Math.max(1, raw.length); }
    }

    if (!ranges.length) return escapeHTML(text);

    // merge
    ranges.sort((a,b)=>a[0]-b[0]||a[1]-b[1]);
    const merged=[]; let cur=ranges[0];
    for (let k=1;k<ranges.length;k++){ const r=ranges[k]; if (r[0]<=cur[1]) cur[1]=Math.max(cur[1],r[1]); else { merged.push(cur); cur=r; } }
    merged.push(cur);

    // render
    let out='', last=0;
    for (const [s,e] of merged){ out+=escapeHTML(text.slice(last,s)); out+='<mark>'+escapeHTML(text.slice(s,e))+'</mark>'; last=e; }
    out+=escapeHTML(text.slice(last));
    return out;
  }

  // Insert a pre-result notice BEFORE the results list
  function insertPreResultNotice(html){
    const old = document.getElementById('preNote');
    if (old) old.remove();
    const note = document.createElement('div');
    note.id = 'preNote';
    note.className = 'empty-box multiline';
    note.style.marginBottom = '10px';
    note.innerHTML = html;
    listDiv.parentNode.insertBefore(note, listDiv);
  }

  /* ---------- Robust logger (JSON POST + sendBeacon + GET pixel) ---------- */
  async function logSearch(name, matches) {
    const payload = {
      name: String(name || ''),
      matches: Number(matches || 0),
      ts: new Date().toISOString(),
      page: location.href,
      ua: navigator.userAgent,
      v: '2025-10-30b'
    };

    // Try 1: JSON POST (opaque when no-cors)
    try {
      await fetch(LOG_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'no-cors',
        body: JSON.stringify(payload)
      });
    } catch (e) {
      console.warn('logSearch JSON POST failed:', e);
    }

    // Try 2: sendBeacon
    try {
      if (navigator.sendBeacon) {
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        navigator.sendBeacon(LOG_ENDPOINT, blob);
      }
    } catch (e) {
      console.warn('logSearch sendBeacon failed:', e);
    }

    // Try 3: 1x1 GET pixel
    try {
      const qs = new URLSearchParams({
        name: payload.name.slice(0, 60),
        matches: String(payload.matches),
        ts: payload.ts,
        page: payload.page.slice(0, 200),
        v: payload.v
      });
      const img = new Image();
      img.referrerPolicy = 'no-referrer';
      img.src = LOG_ENDPOINT + '?' + qs.toString();
    } catch (e) {
      console.warn('logSearch GET beacon failed:', e);
    }
  }

  /* ---------- Load Excel ---------- */
  (async function loadExcel(){
    resetUI();
    try {
      const res = await fetch(excelPath, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = new Uint8Array(await res.arrayBuffer());
      workbook = XLSX.read(data, { type: "array" });
      await afterWorkbookLoaded();
    } catch (e) {
      console.error(e);
      setStatus("åŠ è½½ Excel æ–‡ä»¶å¤±è´¥ï¼šè¯·ç¡®è®¤ orders.xlsx æ˜¯å¦ä¸é¡µé¢åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚", true);
    }
  })();

  async function afterWorkbookLoaded(){
    const props = workbook.Props || {};
    const lastModified = props.ModifiedDate || props.LastSaved || props.DateModified || props.CreatedDate;
    updateTime.textContent = "æœ€åæ›´æ–°æ—¶é—´ï¼š" + (lastModified
      ? (isNaN(new Date(lastModified)) ? String(lastModified) : new Date(lastModified).toLocaleString("zh-CN", { timeZone:"America/Los_Angeles" }))
      : "æœªçŸ¥");

    const limit = Math.min(5, workbook.SheetNames.length);
    sheetDataMap.clear();
    for (let i = 0; i < limit; i++) {
      const sName = workbook.SheetNames[i];
      const sheet = workbook.Sheets[sName];
      const aoa = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true, defval:'' });
      sheetDataMap.set(sName, aoa);
    }

    setStatus(`è¡¨æ ¼åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æŸ¥è¯¢ã€‚`);
    searchBtn.disabled = false;
  }

  /* ---------- Events ---------- */
  nameInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !searchBtn.disabled) doSearch(); });
  nameInput.addEventListener('input', () => { searchBtn.disabled = !(nameInput.value || '').trim(); });
  searchBtn.addEventListener('click', doSearch);
  showPayStatusBox.addEventListener('change', () => { if (!searchBtn.disabled) doSearch(); });
  copyBtn.addEventListener('click', copyResults);

  /* ---------- Search ---------- */
  function doSearch(){
    if (sheetDataMap.size === 0) { setStatus("Excel æ–‡ä»¶æœªåŠ è½½ã€‚", true); return; }
    const key = (nameInput.value || "").trim();
    if (!key) { setStatus("è¯·è¾“å…¥æ‚¨çš„æ¥é¾™åå­—ã€‚", true); return; }

    const results = [];
    // åˆ—æ˜ å°„ï¼šA=0(åˆ°è´§çŠ¶æ€), B=1(æ”¯ä»˜çŠ¶æ€), D=3(å®¢æˆ·å§“å), E=4(æ¥é¾™å†…å®¹), F=5(é‡‘é¢)
    for (const [_, aoa] of sheetDataMap) {
      for (let r = 0; r < aoa.length; r++) {
        const row = aoa[r]; if (!row) continue;
        const dVal = String((row[3] ?? '')).trim();
        if (!dVal && r === 0) continue; // è¡¨å¤´
        if (matchByRule(key, dVal)) {
          const aRaw = (row[0] ?? '');
          const aDisplay = String(aRaw).trim() === '' ? 'æš‚æœªåˆ°è´§' : String(aRaw).trim();
          const bRaw = (row[1] ?? '');
          const bDisplay = String(bRaw).trim() === '' ? 'æœªæ”¯ä»˜' : String(bRaw).trim();
          const e = row[4] ?? '';
          const f = formatUSD(row[5]);
          results.push({ a:aDisplay, b:bDisplay, d:dVal, dHTML:highlightMatches(key, dVal), e, f });
        }
      }
    }

    // log the search (robust)
    logSearch(key, results.length);

    renderResults(results, key);
  }

  function formatUSD(val){
    let num = null;
    if (typeof val === 'number') num = val;
    else {
      const s = String(val ?? '').trim().replace(/,/g, '');
      if (s && !isNaN(s)) num = Number(s);
    }
    if (num === null || !isFinite(num)) return String(val ?? '');
    return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }).format(num);
  }

  /* ---------- Render ---------- */
  function renderResults(rows, key){
    countBadge.textContent = rows.length;
    listDiv.innerHTML = '';
    const showPayStatus = showPayStatusBox.checked;

    // clear previous pre-note
    const existed = document.getElementById('preNote');
    if (existed) existed.remove();

    if (!rows.length) {
      setStatus(`æ²¡æœ‰æ‰¾åˆ° "${key}" çš„è®°å½•ã€‚`, true);
      insertPreResultNotice(
`å“ˆå“ˆè¿™ä½å®¢å®˜ï¼Œæ‚¨å¯èƒ½æ˜¯<b>â€œä¹°äº†ä¸ªå¯‚å¯â€</b>ğŸ˜‚
åº“å­˜å°äºŒåˆšç¿»éå°æœ¬æœ¬ï¼Œå‘ç°æ‚¨æœ€è¿‘æ²¡æœ‰ä¸‹å•å“¦ï½

ä¸æ€¥ä¸æ€¥ï½å®¢æ ˆé‡Œå¥½ç‰©å¤šå¤šï¼Œæ‚¨å¯ä»¥å…ˆå»ç°è´§åŒºæˆ–å…¶ä»–æ¥é¾™æ‘Šä½é€›é€›ï¼Œ
è¯´ä¸å®šä¸‹ä¸€çœ¼ç¼˜åˆ†çš„å®è´å°±åœ¨ç­‰æ‚¨å‘¢âœ¨

å®¢å®˜è¯·éšæ„ï¼Œå–œæ¬¢å“ªä¸ªå°½ç®¡æ‹ï¼Œå°äºŒéšæ—¶ä¸ºæ‚¨æ‰“åŒ…ï½ğŸ“¦ğŸ’¨`
      );
      copyBtn.disabled = true;
      return;
    }

    // â‰¥2 results â†’ show the thank-you note BEFORE results
    if (rows.length >= 2) {
      insertPreResultNotice(
`äº²çˆ±çš„å®¢å®˜ä»¬ï¼Œæœ€è¿‘çœ‹åˆ°æ‚¨å›¤è´§çš„çƒ­æƒ…ï¼Œå°äºŒæ„ŸåŠ¨å¾—çœ¼æ³ªéƒ½å¿«æ‰è¿›æ‰“åŒ…è¢‹é‡Œäº†ğŸ’ª
æ„Ÿè°¢æ‚¨ä¸€è·¯æ”¯æŒã€ä¿¡ä»»ä¸åšçˆ±ï¼
æ‚¨çš„æ¯ä¸€æ¬¡ä¸‹å•ï¼Œéƒ½æ˜¯å¯¹å°äºŒç»§ç»­åŠªåŠ›çš„æœ€å¤§é¼“åŠ±â¤ï¸
ç¥æ‚¨æ—¥æ—¥æœ‰å¥½ç‰©ï¼Œä»¶ä»¶éƒ½å–œæ¬¢ï¼`
      );
    }

    setStatus(`æ‰¾åˆ° ${rows.length} æ¡è®°å½•ã€‚`);

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th style="width:64px;">åºå·</th>
          <th style="width:120px;">åˆ°è´§çŠ¶æ€</th>
          ${showPayStatus ? '<th style="width:120px;">æ”¯ä»˜çŠ¶æ€</th>' : ''}
          <th>å®¢æˆ·å§“å</th>
        </tr>
      </thead>`;
    const tb = document.createElement('tbody');

    rows.forEach((r, i) => {
      // main row
      const tr = document.createElement('tr');
      const cell = (txt) => { const td = document.createElement('td'); td.textContent = txt; tr.appendChild(td); };
      const cellHTML = (html) => { const td = document.createElement('td'); td.innerHTML = html; tr.appendChild(td); };

      cell(i+1);
      cell(r.a);
      if (showPayStatus) cell(r.b === '' ? 'æœªæ”¯ä»˜' : r.b);
      cellHTML(r.dHTML);
      tb.appendChild(tr);

      // detail rowï¼ˆE, Fï¼‰
      const tr2 = document.createElement('tr');
      tr2.className = 'detail-row';
      const td = document.createElement('td');
      td.colSpan = showPayStatus ? 4 : 3;

      const wrap = document.createElement('div');
      wrap.className = 'detail-meta';
      const eDiv = document.createElement('div');
      const fDiv = document.createElement('div');
      eDiv.innerHTML = `<b>æ¥é¾™å†…å®¹ï¼š</b>${escapeHTML(String(r.e ?? ''))}`;
      fDiv.innerHTML = `<b>åº”ä»˜é‡‘é¢ï¼ˆUSDï¼‰ï¼š</b>${escapeHTML(String(r.f ?? ''))}`;
      wrap.appendChild(eDiv);
      wrap.appendChild(fDiv);

      td.appendChild(wrap);
      tr2.appendChild(td);
      tb.appendChild(tr2);
    });

    table.appendChild(tb);
    listDiv.appendChild(table);
    copyBtn.disabled = false;
  }

  /* ---------- Copy TSV ---------- */
  async function copyResults(){
    const showPayStatus = showPayStatusBox.checked;
    const header = ['åºå·','åˆ°è´§çŠ¶æ€'];
    if (showPayStatus) header.push('æ”¯ä»˜çŠ¶æ€');
    header.push('å®¢æˆ·å§“å','æ¥é¾™å†…å®¹','åº”ä»˜é‡‘é¢ï¼ˆUSDï¼‰');

    const key = (nameInput.value || "").trim();
    const res = [];
    for (const [_, aoa] of sheetDataMap) {
      for (let r = 0; r < aoa.length; r++) {
        const row = aoa[r]; if (!row) continue;
        const dVal = String((row[3] ?? '')).trim();
        if (!dVal && r === 0) continue;
        if (matchByRule(key, dVal)) {
          const aRaw = (row[0] ?? '');
          const aDisplay = String(aRaw).trim() === '' ? 'æš‚æœªåˆ°è´§' : String(aRaw).trim();
          const bRaw = (row[1] ?? '');
          const bDisplay = String(bRaw).trim() === '' ? 'æœªæ”¯ä»˜' : String(bRaw).trim();
          const e = row[4] ?? '';
          const f = formatUSD(row[5]);
          res.push({ a:aDisplay, b:bDisplay, d:dVal, e, f });
        }
      }
    }
    const lines = res.map((r, i) => {
      const arr = [i+1, r.a];
      if (showPayStatus) arr.push(r.b);
      arr.push(r.d, r.e, r.f);
      return arr.join('\t');
    });

    const text = header.join('\t') + '\n' + lines.join('\n');
    try {
      await navigator.clipboard.writeText(text);
      setStatus("ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚", false, true);
    } catch {
      setStatus("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶ã€‚", true);
    }
  }

  /* ---------- UI state ---------- */
  function setStatus(msg, isError=false, good=false){
    statusDiv.textContent = msg;
    statusDiv.className = isError ? 'error' : good ? 'good' : 'muted';
  }

  function resetUI(){
    workbook = null; sheetDataMap.clear();
    listDiv.innerHTML = ''; countBadge.textContent = '0';
    copyBtn.disabled = true; searchBtn.disabled = true;
    setStatus("æ­£åœ¨åŠ è½½è¡¨æ ¼â€¦");
  }
})();
</script>
</body>
</html>







































































